<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Khaled Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="images/favicon.png">
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <a href="#" onclick="goHome()" class="logo">
            <img src="images/logo-icon.png" class="logo-icon" alt="Icon">
            <img src="images/logo-text.png" class="logo-text" alt="Khaled Store">
        </a>
        <div class="header-icons" onclick="toggleCart()">
          <div class="cart-icon-wrapper">
            <ion-icon name="cart-outline"></ion-icon>
            <span id="cartCount" class="cart-count">0</span>
          </div>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div id="home-page">
        <div class="hero-banner">
            <h1>أحدث كوليكشن سنيكرز 2026</h1>
            <button onclick="scrollToCatalogue()">تسوق الآن</button>
        </div>
        <section id="catalogue-section" class="catalogue-section">
            <h2 class="section-title">الأكثر مبيعاً</h2>
            <div class="catalogue-grid" id="catalogueGrid">
                <p style="text-align:center; width:100%; grid-column: 1/-1;">جاري تحميل المنتجات...</p>
            </div>
        </section>
      </div>

      <div id="product-page" style="display: none;">
        <button onclick="goHome()" class="back-btn"><ion-icon name="arrow-forward-outline"></ion-icon> الرجوع للكتالوج</button>
        <div class="product-container">
            <div class="product-gallery">
                <div class="main-image-wrapper"><img src="" id="mainDisplayImage" alt="المنتج"></div>
                <div class="thumbnails-scroll" id="thumbnailsContainer"></div>
            </div>
            <div class="product-details">
                <h1 class="product-title" id="mainTitle">اسم المنتج</h1>
                <div class="price-container">
                    <span class="current-price" id="mainPrice">000 ج.م</span>
                </div>
                <div class="order-form">
                    <div class="options-group"><label class="form-label">اللون:</label><div class="selection-grid" id="colorsContainer"></div></div>
                    <div class="options-group" style="margin-top: 15px;"><label class="form-label">المقاس:</label><div class="selection-grid" id="sizesContainer"></div></div>
                    <div class="quantity-group" style="margin-top: 15px;">
                        <label class="form-label">العدد:</label>
                        <div class="qty-control">
                            <button class="qty-btn" onclick="updateQty(-1)">-</button><span id="qtyDisplay">1</span><button class="qty-btn" onclick="updateQty(1)">+</button>
                        </div>
                    </div>
                    <div class="client-info-section" style="margin-top:20px;">
                        <input type="text" id="clientName" class="form-input" placeholder="الاسم بالكامل">
                        <input type="tel" id="clientPhone" class="form-input" placeholder="رقم الموبايل">
                        <input type="text" id="clientAddress" class="form-input" placeholder="العنوان بالتفصيل">
                    </div>
                    <div class="buttons-group">
                        <button onclick="addToCart()" class="btn-add-cart"><ion-icon name="bag-add-outline"></ion-icon> أضف للشنطة</button>
                        <button onclick="sendOrder()" class="btn-submit">تأكيد الطلب الآن</button>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </main>

    <footer id="contact" class="footer">
      <div class="footer-content">
        <h3>تواصل معنا</h3>
        <div class="contact-links">
            <a href="https://wa.me/201012345678" target="_blank"><ion-icon name="logo-whatsapp"></ion-icon> واتساب</a>
            <a href="tel:01012345678"><ion-icon name="call-outline"></ion-icon> اتصال</a>
        </div>
        <p class="copyright">© 2026 Khaled Store</p>
      </div>
    </footer>

    <div class="cart-overlay" onclick="toggleCart()"></div>
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header"><h3>سلة المشتريات</h3><span class="close-cart" onclick="toggleCart()">&times;</span></div>
        <div class="cart-items" id="cartItemsContainer"><p style="text-align:center;">الشنطة فارغة</p></div>
        <div class="cart-footer">
            <div class="total-price"><span>الإجمالي:</span><span id="cartTotal">0 ج.م</span></div>
            <button onclick="checkout()" class="btn-checkout">إتمام الشراء</button>
        </div>
    </div>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // تهيئة EmailJS
        (function(){ emailjs.init("RmiJSgyGmBczzutlF"); })();

        // رابط سكربت جوجل شيت
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwhaOdK3p9VYSxnNBvSFbIz9FheRqrXY6fJIIS83Re11DfoiREerHTIMpvIjMPHbcPM4A/exec";

        let allProducts = [], currentProduct = null, cart = [], currentQty = 1;

        async function loadProducts() {
            try {
                const response = await fetch('/.netlify/functions/get-products');
                if (!response.ok) throw new Error("Server Error");
                const products = await response.json();
                allProducts = products;
                renderCatalogue(products);
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('catalogueGrid').innerHTML = '<p style="text-align:center; grid-column:1/-1;">خطأ في الاتصال، حاول مرة أخرى.</p>';
            }
        }

        function renderCatalogue(products) {
            const grid = document.getElementById('catalogueGrid');
            grid.innerHTML = ''; 
            if(products.length === 0) { grid.innerHTML = '<p>لا توجد منتجات.</p>'; return; }
            products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'catalogue-card';
                card.onclick = () => openProductPage(p.id);
                card.innerHTML = `<img src="${p.mainImage}" alt="${p.title}"><div class="card-info"><h3>${p.title}</h3><p class="price">${p.price} ج.م</p></div>`;
                grid.appendChild(card);
            });
        }

        function openProductPage(id) {
            const product = allProducts.find(p => p.id === id);
            if(!product) return;
            currentProduct = product;
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('product-page').style.display = 'block';
            document.getElementById('mainTitle').innerText = product.title;
            document.getElementById('mainPrice').innerText = product.price + ' ج.م';
            currentQty = 1; document.getElementById('qtyDisplay').innerText = 1;
            
            const colorsDiv = document.getElementById('colorsContainer'); colorsDiv.innerHTML = '';
            product.colors.forEach((c, i) => {
                colorsDiv.innerHTML += `<input type="radio" name="color" id="c-${i}" value="${c.value}" data-name="${c.name}" onclick="updateGallery(${i})" ${i===0?'checked':''}><label for="c-${i}" class="option-btn">${c.name}</label>`;
            });

            const sizesDiv = document.getElementById('sizesContainer'); sizesDiv.innerHTML = '';
            product.sizes.forEach(s => {
                sizesDiv.innerHTML += `<input type="radio" name="size" id="s${s}" value="${s}"><label for="s${s}" class="option-btn">${s}</label>`;
            });

            if(product.colors.length > 0) updateGallery(0);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateGallery(idx) {
            const images = currentProduct.colors[idx].images;
            document.getElementById('mainDisplayImage').src = images[0];
            const thumbs = document.getElementById('thumbnailsContainer'); thumbs.innerHTML = '';
            images.forEach((url, i) => {
                const img = document.createElement('img'); img.src = url; img.className = `thumb-img ${i===0?'active-thumb':''}`;
                img.onclick = function() { document.getElementById('mainDisplayImage').src = url; document.querySelectorAll('.thumb-img').forEach(e=>e.classList.remove('active-thumb')); this.classList.add('active-thumb'); };
                thumbs.appendChild(img);
            });
        }

        function addToCart() {
            const size = document.querySelector('input[name="size"]:checked');
            const color = document.querySelector('input[name="color"]:checked');
            if (!size || !color) { alert("اختار المقاس واللون"); return; }
            for(let i=0; i<currentQty; i++) {
                cart.push({id: Date.now()+i, title: currentProduct.title, price: currentProduct.price, image: document.getElementById('mainDisplayImage').src, size: size.value, color: color.getAttribute('data-name')});
            }
            updateCartUI(); toggleCart();
        }

        function updateCartUI() {
            document.getElementById('cartCount').innerText = cart.length;
            document.getElementById('cartTotal').innerText = cart.reduce((s, i) => s + i.price, 0) + ' ج.م';
            const container = document.getElementById('cartItemsContainer');
            if(cart.length === 0) { container.innerHTML = '<p style="text-align:center;">الشنطة فارغة</p>'; return; }
            container.innerHTML = cart.map((item, i) => `<div class="cart-item"><img src="${item.image}"><div class="item-details"><h4>${item.title}</h4><p>${item.color} | ${item.size}</p><p>${item.price} ج.م</p><span class="remove-item" onclick="cart.splice(${i},1); updateCartUI();" style="color:red;cursor:pointer">حذف</span></div></div>`).join('');
        }

        // --- دالة إرسال الطلب (المحدثة والشاملة) ---
        async function sendOrder() {
            // 1. التحقق من البيانات
            const name = document.getElementById("clientName").value;
            const phone = document.getElementById("clientPhone").value;
            const address = document.getElementById("clientAddress").value;

            if (!name || !phone || !address) { 
                alert("اكمل البيانات"); 
                return; 
            }

            // 2. تحديث شكل الزرار
            const btn = document.querySelector('.btn-submit'); 
            btn.innerText = "جاري الحفظ..."; 
            btn.disabled = true;

            // 3. تجهيز تفاصيل الطلب والسعر
            let details = cart.length 
                ? cart.map(i => `- ${i.title} (${i.color}, ${i.size})`).join('\n') 
                : `${currentProduct.title} (العدد ${currentQty})`;
                
            let total = cart.length 
                ? cart.reduce((s, i) => s + i.price, 0) 
                : currentProduct.price * currentQty;

            // 4. تجهيز البيانات
            const orderData = { 
                name: name, 
                phone: phone, 
                address: address, 
                details: details, 
                total: total + " ج.م", 
                coupon: "لا يوجد" 
            };

            try {
                // إرسال البيانات للثلاث جهات في وقت واحد
                await Promise.all([
                    // 1. قاعدة بيانات Neon
                    fetch('/.netlify/functions/create-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    }),

                    // 2. جوجل شيت
                    fetch(SCRIPT_URL, { 
                        method: "POST", 
                        mode: "no-cors", 
                        headers: { "Content-Type": "application/json" }, 
                        body: JSON.stringify(orderData) 
                    }),

                    // 3. إيميل JS
                    emailjs.send("service_wgf1a3s", "template_ezk9gyk", {
                        name: name, 
                        phone: phone, 
                        address: address, 
                        message: details, 
                        color: total + " ج.م"
                    })
                ]);

                // لو كله تمام:
                cart = [];
                updateCartUI();
                // التوجيه لصفحة الشكر اللي عملناها
                window.location.href = 'success.html';

            } catch (error) {
                console.error("حصل خطأ:", error);
                // بنعتبر الطلب وصل حتى لو حصل خطأ بسيط عشان منخسرش العميل
                // وبنحوله لصفحة النجاح برضو
                window.location.href = 'success.html';
            } finally {
                btn.innerText = "تأكيد الطلب";
                btn.disabled = false;
            }
        }

        function updateQty(n) { currentQty += n; if(currentQty<1) currentQty=1; document.getElementById('qtyDisplay').innerText=currentQty; }
        function toggleCart() { document.getElementById('cartSidebar').classList.toggle('active'); document.querySelector('.cart-overlay').classList.toggle('active'); }
        function goHome() { document.getElementById('home-page').style.display = 'block'; document.getElementById('product-page').style.display = 'none'; window.scrollTo(0,0); }
        function scrollToCatalogue() { document.getElementById('catalogue-section').scrollIntoView({behavior:'smooth'}); }
        function checkout() { toggleCart(); if(document.getElementById('product-page').style.display === 'none') { alert("اختر منتجاً أولاً"); scrollToCatalogue(); return; } document.getElementById('clientName').scrollIntoView({behavior:'smooth'}); }
        
        window.addEventListener("scroll", () => document.querySelector(".header").classList.toggle("scrolled", window.scrollY > 50));
        document.addEventListener('DOMContentLoaded', loadProducts);
    </script>
  </body>
</html>
